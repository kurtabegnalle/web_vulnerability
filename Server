import socket

import psycopg2

DB_NAME = "user"
DB_USER = "user"
DB_PASSWORD = "12345678"
HOST = "localhost"
AUTH_OK = "Аутентификация пройдена! Добро пожаловать!"
AUTH_ERR = "Неверный логин или пароль! Попробуйте снова!"


def check_db_user(db_name, db_user, u_passwd, host, login, password) -> bool:
    conn = psycopg2.connect(dbname=db_name, user=db_user, password=u_passwd, host=host)
    cursor = conn.cursor()
    data = "SELECT * FROM users WHERE login = " + "'" + login + "'" + " AND password = " + "'" + password + "'"
    cursor.execute(data)
    records = cursor.fetchall()
    cursor.close()
    conn.close()
    if len(records) != 0:
        return True
    else:
        return False


def start_server():
    global login
    host_name = socket.gethostname()
    port = 8080

    socket_server = socket.socket()
    socket_server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    socket_server.bind((host_name, port))

    print("Сервер запущен. Ждет входящих подключений.")

    socket_server.listen(1)
    conn, addr = socket_server.accept()

    print(f"Клиент {addr} подключился к серверу. Ожидаю данных для аутентификации.")

    while True:
        data = conn.recv(512)
        split_data = data.decode("utf-8").split(": ")
        if split_data[0] == "login":
            login = split_data[1]
            print(f"Попытка входа пользователя - {login}")
        elif split_data[0] == "password":
            password = split_data[1]
            print(f"Пользователь {login} ввел пароль, хэш - {password}, проверяю данные аутентификации...")
            check_auth = check_db_user(DB_NAME, DB_USER, DB_PASSWORD, HOST, login, password)
            if check_auth:
                print(f"Пользователь {login} успешно прошел аутентификацию!")
                conn.send(AUTH_OK.encode())
                conn.close()
                socket_server.close()
                break
            else:
                print(f"Пользователь {login} не прошел аутентификацию!")
                conn.send(AUTH_ERR.encode())


if __name__ == '__main__':
    start_server()
